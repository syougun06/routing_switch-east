#!/usr/bin/env ruby
$LOAD_PATH.unshift File.join(__dir__, '..', 'lib')

require 'gli'
require 'trema'
require 'sliceable_switch'

# slice command
module Slice
  extend GLI::App

  desc 'Creates a new virtual slice'
  arg_name 'name'
  command :add do |c|
    c.desc 'Location to find socket files'
    c.flag [:S, :socket_dir], default_value: Trema::DEFAULT_SOCKET_DIR

    c.action do |_global_options, options, args|
      fail 'slice name is required.' if args.empty?
      Trema.controller_process(options[:socket_dir]).
        sliceable_switch.
        add_slice(args.first)
    end
  end

  desc 'Lists slices'
  command :list do |c|
    c.desc 'Location to find socket files'
    c.flag [:S, :socket_dir], default_value: Trema::DEFAULT_SOCKET_DIR

    c.action do |_global_options, options, _args|
      DRb.start_service
      slices = Trema.controller_process(options[:socket_dir]).
               sliceable_switch.
               slices
      slices.each_pair do |slice, ports|
        puts slice
        ports.each do |port, mac_addresses|
          puts "  #{format '%#x', port[:dpid]}:#{port[:port_no]}"
          mac_addresses.each do |each|
            puts "    #{each}"
          end
        end
      end
    end
  end

  desc 'Adds a host to a slice'
  command :add_host do |c|
    c.desc 'MAC address'
    c.flag [:m, :mac]
    c.desc 'Switch port'
    c.flag [:p, :port]
    c.desc 'Slice name'
    c.flag [:s, :slice]
    c.desc 'Location to find socket files'
    c.flag [:S, :socket_dir], default_value: Trema::DEFAULT_SOCKET_DIR

    c.action do |_global_options, options, _args|
      DRb.start_service
      fail '--mac option is mandatory.' unless options[:mac]
      fail '--port option is mandatory.' unless options[:port]
      unless /\A(\S+):(\d+)\Z/ =~ options[:port]
        fail "Invalid switch port #{options[:port]}"
      end
      dpid_str = Regexp.last_match(1)
      port_no = Regexp.last_match(2).to_i
      dpid = (/\A0x/ =~ dpid_str) ? dpid_str.hex : dpid_str.to_i
      fail '--slice option is mandatory.' unless options[:slice]
      Trema.controller_process(options[:socket_dir]).
        sliceable_switch.
        find_slice(options[:slice]).
        add_mac_address(options[:mac], dpid: dpid, port_no: port_no)
    end
  end

  desc 'Deletes a host from a slice'
  command :delete_host do |c|
    c.desc 'MAC address'
    c.flag [:m, :mac]
    c.desc 'Switch port'
    c.flag [:p, :port]
    c.desc 'Slice name'
    c.flag [:s, :slice]
    c.desc 'Location to find socket files'
    c.flag [:S, :socket_dir], default_value: Trema::DEFAULT_SOCKET_DIR

    c.action do |_global_options, options, _args|
      fail '--mac option is mandatory.' unless options[:mac]
      fail '--port option is mandatory.' unless options[:port]
      unless /\A(\S+):(\d+)\Z/ =~ options[:port]
        fail "Invalid switch port #{options[:port]}"
      end
      dpid_str = Regexp.last_match(1)
      port_no = Regexp.last_match(2).to_i
      dpid = (/\A0x/ =~ dpid_str) ? dpid_str.hex : dpid_str.to_i
      fail '--slice option is mandatory.' unless options[:slice]
      Trema.controller_process(options[:socket_dir]).
        sliceable_switch.
        find_slice(options[:slice]).
        delete_mac_address(options[:mac], dpid: dpid, port_no: port_no)
    end
  end

  exit run(ARGV)
end
